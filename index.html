<!DOCTYPE html>
<meta charset="UTF-8">
<html>

<body>
    <title>Design</title>
    <link rel="stylesheet" href="css/design.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/welcomeWizzard.css">
    <link rel="stylesheet" href="css/toggle.css">
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/tickbox.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/layerManager.css">
    <!--<link rel="stylesheet" href="css/contextmenu.css">-->
    <link rel="stylesheet" href="css/popover.css">
    <link rel="stylesheet" href="css/colourpicker.css">
    <link rel="stylesheet" href="css/dropdown.css">
    <link rel="stylesheet" href="css/notification.css">

    <div role="main">
        <canvas id="designCanvas">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
    </div>

    <div class="toolbar">
        <input type="file" style="display:none" name="fileupload" value="fileupload" id="fileupload">
        <div class="tooltip"><button class="designicon" , onclick="showSettings()"><img
                    src="icons/design-small.svg"></button></div>
        <div class="tooltip"><button class="tool" , onclick="selectFileClicked()"><img src="icons/open.svg"></button>
            <span class="tooltiptext">Open File</span>
        </div>
        <div class="tooltip"><button class="tool" , onclick="saveFileClicked()"><img src="icons/save.svg"></button>
            <span class="tooltiptext">Save</span>
        </div>
        <div class="tooltip"><span class="separator"></span></div>
        <div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('L')"><img
                    src="icons/line.svg"></button> <span class="tooltiptext">Line (L)</span></div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('PL')"><img src="icons/polyline.svg"></button>
            <span class="tooltiptext">Polyline (PL)</span>
        </div>
        <div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('C')"><img
                    src="icons/circle.svg"></button> <span class="tooltiptext">Circle (C)</span></div>
        <div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('A')"><img
                    src="icons/arc.svg"></button> <span class="tooltiptext">Arc (A)</span></div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('REC')"><img
                    src="icons/rectangle.svg"></button> <span class="tooltiptext">Rectangle (REC)</span></div>
        <!--<div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('EL'] )"><img src="icons/ellipse.svg"></button>  <span class="tooltiptext">Ellipse (EL)</span></div>-->
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('DT')"><img src="icons/text.svg"></button>
            <span class="tooltiptext">Text (DT)</span>
        </div>
        <!--<div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('DIM'] )"><img src="icons/dimension.svg"></button> <span class="tooltiptext">Dimension (DIM)</span></div>-->
        <div class="tooltip"><span class="separator"></span></div>
        <div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('M')"><img
                    src="icons/move.svg"></button> <span class="tooltiptext">Move (M)</span></div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('CO')"><img src="icons/copy.svg"></button>
            <span class="tooltiptext">Copy (CO)</span>
        </div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('RO')"><img src="icons/rotate.svg"></button>
            <span class="tooltiptext">Rotate (RO)</span>
        </div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('TR')"><img src="icons/trim.svg"></button>
            <span class="tooltiptext">Trim (TR)</span>
        </div>
        <div class="tooltip"><button class="tool" ,
                onclick="designCore.scene.inputManager.onCommand('EX')"><img src="icons/extend.svg"></button>
            <span class="tooltiptext">Extend (EX)</span>
        </div>
        <div class="tooltip"><button class="tool" , onclick="designCore.scene.inputManager.onCommand('E')"><img
                    src="icons/erase.svg"></button> <span class="tooltiptext">Erase (E)</span></div>

        <div class="tooltip"><span class="separator"></span></div>
        <div class="tooltip"><button class="tool" , onclick="showHideLayerManager()"><img
                    src="icons/layers.svg"></button><span class="tooltiptext">Layers</span></div>
        <div class="tooltip"><button class="tool" , onclick="showHidePropertiesManager()"><img
                    src="icons/properties.svg"></button><span class="tooltiptext">Properties</span></div>
    </div>
</body>

<!--<footer>-->
<canvasbottom id="foot">
    <input id="cmdLine" type="text">
    <!--<button class="popup" , onclick="showPopup()" id="myPopup"><img src="icons/erase.svg"></button> -->
    <label id="coordLabel">label</label>
</canvasbottom>
<!--</footer>-->

<!--<script type="text/javascript" src="Design-designCore/help/help.js"></script>-->
<!-- used for saving file data -->
<script type="text/javascript" src="js/FileSaver.min.js"></script>

<!-- Load webcomponents-->
<script type="module" src="./js/colourPicker.js"></script>

<script type="module">
    // Local copy of design-core for development
    //import { Core } from "./js/Design-Core/core/core.js"
    //import { Colours } from "./js/Design-Core/core/lib/colours.js"
    
    // served copy of design-core for production
    import { Core } from "https://cdn.jsdelivr.net/gh/dubstar-04/Design-Core/core/core.js"
    import { Colours } from "https://cdn.jsdelivr.net/gh/dubstar-04/Design-Core/core/lib/colours.js"

    // instanciate Design Core
    window.designCore = new Core();

    // provide access to the colours class
    window.Colours = Colours;

    initdesignCore();
</script>

<script>
    var designVersion = "Pre-Alpha-Dev";
    var coordinatesLabel = document.getElementById('coordLabel')
    var cmd_Line = document.getElementById('cmdLine')
    var cnvs = document.getElementById('designCanvas');
    cnvs.style.cursor = "crosshair";

    function initdesignCore() {
        designCore.canvas.setCanvasWidget(cnvs);
        designCore.commandLine.setUpdateFunction(commandLineUpdateCallback);
        designCore.canvas.setExternalPaintCallbackFunction(paint);
        designCore.propertyManager.setPropertyCallbackFunction(propertyCallback)
        initCanvas();
    }

    // callback passed to the core.propertyManager class to update item selections and properties
    function propertyCallback() {
        console.log("Index - Property Callback")
        getProperties()
    }

    // callback passed to the core.commandline class to update this cmd_line value
    function commandLineUpdateCallback(commandLineValue) {
        cmd_Line.value = commandLineValue;
    }

    function paint() {
        var cr = cnvs.getContext('2d');

        cnvs.width = window.innerWidth;
        cnvs.height = window.innerHeight;

        // resize canvas to window
        var width = cnvs.width;
        var height = cnvs.height;

        // Clear the canvas
        cr.save();
        cr.setTransform(1, 0, 0, 1, 0, 0);
        cr.clearRect(0, 0, width, height);
        cr.restore();


        designCore.canvas.paint(cr, width, height);
    }

    function initCanvas() {

        // Mouse Events
        cnvs.addEventListener('mousedown', mouseDown, false);
        cnvs.addEventListener('mouseup', mouseUp, false);
        cnvs.addEventListener('DOMMouseScroll', wheel, false);
        cnvs.addEventListener('mousemove', mouseMoved, false);

        //Keyboard Events
        document.addEventListener('keydown', keypress, false);

        function writeCoordinatesLabel() {
            coordinatesLabel.innerHTML = designCore.mouse.positionString()
        }

        function mouseMoved(event) {
            designCore.mouse.mouseMoved(event.clientX, event.clientY);
            writeCoordinatesLabel();
        }

        function wheel(event) {
            // delta = +/- 1 for zoom in / out
            var delta = event.detail / 3;
            designCore.mouse.wheel(delta);
            writeCoordinatesLabel();
        }

        function mouseDown(event) {
            // button: 0 = left, 1 = wheel, 2 = right;
            event.preventDefault();
            designCore.mouse.mouseDown(event.button);
        }

        function mouseUp(event) {
            // button: 0 = left, 1 = wheel, 2 = right;
            event.preventDefault();
            designCore.mouse.mouseUp(event.button);
        }

        function keypress(event) {
            if (lastDownTarget == cnvs || lastDownTarget == cmd_Line) {

                event.preventDefault()

                var charCode = (event.charCode) ? event.charCode : event.keyCode;
                console.log("char code", event.keyVal, event.keyCode)

                var key;

                switch (charCode) {
                    case 8: //Backspace
                        key = "Backspace";
                        break;
                    case 9: //Tab
                        break;
                    case 13: //Enter
                        key = "Enter";
                        break;
                    case 16: // Shift
                        break;
                    case 17: // Ctrl
                        break;
                    case 27: // Escape
                        key = "Escape";
                        break;
                    case 32: // space
                        key = "Space";
                        break;
                    case 37: // Left-Arrow
                        break;
                    case 38: // Up-Arrow
                        key = "Up-Arrow";
                        break;
                    case 39: // Right-Arrow
                        break;
                    case 40: // Down-Arrow
                        key = "Down-Arrow";
                        break;
                    case 46: // Delete
                        key = "Delete";
                        break;
                    case 112: // F1
                        showSettings()
                        changeTab(event, 'Help')
                        break;
                    case 113: // F2
                        break;
                    case 114: // F3
                        //this.disableSnaps(e);
                        break;
                    case 115: // F4
                        break;
                    case 116: // F5
                        break;
                    case 117: // F6
                        break;
                    case 118: // F7
                        toggleSnap('drawGrid')
                        break;
                    case 119: // F8
                        toggleSnap('ortho')
                        break;
                    case 120: // F9
                        break;
                    case 121: // F10
                        toggleSnap('polar');
                        break;
                    case 122: // F11
                        break;
                    case 123: // F12
                        break;

                    default:
                        key = event.key
                }

                designCore.commandLine.handleKeys(key);
            }
        }

        // prevent the browser context menu from appearing
        window.addEventListener('contextmenu', function (e) {
            e.preventDefault()
        }, false);

        window.addEventListener('resize', function () {
            hideModals()
        }, false);

        document.getElementById('fileupload').addEventListener("change", function () {
            console.log(document.getElementById('fileupload').files[0])

            var file = (document.getElementById('fileupload').files[0])
            console.log("open file:", file)

            var reader = new FileReader();
            reader.onload = function () {
                var text = reader.result;
                //openFile(text);
                designCore.openFile(text);
            };

            reader.readAsText(file);

        });
    }

    function selectFileClicked() {
        document.getElementById('fileupload').click()

    }

    function saveFileClicked() {

        var dxfData = designCore.saveFile()

        var blob = new Blob([dxfData], {
            type: "text/plain;"
        });
        saveAs(blob, "design.dxf");
    }

    function hideModals() {
        const cp = document.getElementById('colPick');
        cp.hideColourPicker();
        //closeColourPicker();
        closePopover();
        closeSettings();
    }

    var lastDownTarget
    window.onload = function () {
        document.addEventListener('mousedown', function (event) {
            lastDownTarget = event.target;
        }, false);

        loadAllSettings();
        //designCore.canvas.resizeCanvas();
        getCookieConsent();
        paint();

    }
</script>



<!---------------------------------------------------
------------------- colourPicker --------------------
---------------------------------------------------->
<colour-picker id="colPick"></colour-picker>


<!---------------------------------------------------
------------------- layermanager --------------------
---------------------------------------------------->

<div id="LayerManager" class="Design-sidebar">
    <div class="Design-header">
        <div class="Design-header-icon" , onclick="closeLayerManager()"><img src="icons/close.svg"></div>
        <div class="Design-header-title">
            <h3>Layers</h3>
        </div>
        <div class="Design-header-icon" , onclick="addNewLayer()"><img src="icons/add.svg"></div>
    </div>
    <div id="LayerManagerContent" class="Design-sidebar-content">
        <!--  <div class="LayerManager-body">-->

        <ul id="LayerManagerList" class="Design-sidebar-list">
            <!-- Dynamically add layer list -->
        </ul>
        <!-- </div> -->
    </div>
</div>

<script>

    function showHideLayerManager() {

        var LM = document.getElementById("LayerManager");

        if (LM.style.width > "0px") {
            closeLayerManager();
        } else {
            closePropertiesManager();
            LM.style.width = "300px";
            loadLayers();
        }
    }

    function addNewLayer() {
        designCore.layerManager.newLayer()
        loadLayers();
    }

    /* Set the width of the side navigation to 0 */
    function closeLayerManager() {
        document.getElementById("LayerManager").style.width = "0";
    }

    function showlayerDetails(elemID) {

        for (var layer = 0; layer < designCore.layerManager.layerCount(); layer++) {
            // if (layers[layer].name + "-layerDetails" === elemID + "Details") {
            {

                var layer = designCore.layerManager.getLayerByIndex(layer);

                var detailsDiv = document.getElementById(elemID + "Details")
                //detailsDiv.innerHTML = '';

                var layerName = layer.name

                detailsDiv.innerHTML = ' \
		<div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>Frozen</p></div> \
		<div class="Design-sidebar-listitem-child"> \
		<label class="tickbox"><input type="checkbox" id="' + layerName + 'frozenStatus" onclick="frozen(' + layerName + ', this.checked)"/><span class="tkbtn"></span></label> \
		</div> \
		</div> \
		<div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>Locked</p></div> \
				<div class="Design-sidebar-listitem-child"> \
		<label class="tickbox"><input type="checkbox" id="' + layerName + 'lockedStatus" onclick=""/><span class="tkbtn"></span></label> \
		</div> \
		</div> \
		<div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>Plot</p></div> \
				<div class="Design-sidebar-listitem-child"> \
		<label class="tickbox"><input type="checkbox" id="' + layerName + 'plottingStatus" onclick=""/><span class="tkbtn"></span></label> \
		</div> \
		</div> \
		<div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>Linetype</p></div> \
		<div class="Design-sidebar-listitem-child"><p id="' + layerName + 'linetypeStatus"></p></div> \
		</div> \
		<div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>Lineweight</p></div> \
		<div class="Design-sidebar-listitem-child"><p id="' + layerName + 'lineweightStatus"></p></div> \
		</div> \
		';

                document.getElementById(layerName + "frozenStatus").checked = layer.frozen;
                document.getElementById(layerName + "lockedStatus").checked = layer.locked;
                document.getElementById(layerName + "plottingStatus").checked = layer.plotting;
                document.getElementById(layerName + "linetypeStatus").innerHTML = layer.lineType;
                document.getElementById(layerName + "lineweightStatus").innerHTML = layer.lineWeight;

            }
        }
    }

    function showHideLayerDetails(elemID) {

        var elemIDstate = document.getElementById(elemID + "Details").style.display;
        console.log(elemID, elemIDstate)

        //hide any expanded sections

        var divs = document.querySelectorAll("[id]");
        for (var i = 0, len = divs.length; i < len; i++) {
            var div = divs[i];
            if (div.id.indexOf("Details") > -1) {
                div.style.height = "0px";
                div.style.display = "none";
            }
        }

        if (elemIDstate !== "block") {
            document.getElementById(elemID + "Details").style.display = "block";
            document.getElementById(elemID + "Details").style.height = "260px";
            showlayerDetails(elemID)
            //console.log("Show Details")
        }
    }

    function layerColourChange(colour, layerIndex) {
        console.log("change ", layerIndex, " to: ", colour);
        designCore.layerManager.layers[layerIndex].colour = colour;
        loadLayers();
        //closePopover()
        designCore.canvas.requestPaint()
    }

    function handleMouse(e, elem, layerID, layerIndex) {
        e.preventDefault();
        //console.log("Show/Hide: ", layerID);

        switch (e.button) {

            case 0:
                //console.log("left");
                if (elem === "name") {
                    showHideLayerDetails(layerID)
                }
                if (elem === "colour") {
                    const cp = document.getElementById('colPick');
                    cp.showColourPicker(e, layerColourChange, layerIndex);
                }

                break;

            case 1:
                //console.log("middle");
                break;

            case 2:
                //console.log("right");
                var listItems = [{
                    name: "Rename",
                    action: function () {
                        console.log("Rename layer:", designCore.layerManager.getLayerByIndex(layerIndex).name);
                        closePopover();
                        var edit = document.getElementById(layerID)
                        var style = getComputedStyle(document.body);
                        var colour = style.getPropertyValue('--active-colour');
                        edit.style.outline = colour + " solid 1px"
                        // set the focus on the text edit. timer needed as a hack
                        window.setTimeout(function () {
                            edit.focus();
                        }, 0);
                    }
                }, {
                    name: "Delete",
                    action: function () {
                        designCore.layerManager.deleteLayer(layerIndex);
                        closePopover();
                        loadLayers();
                        designCore.canvas.requestPaint();
                    }
                }];
                if (designCore.layerManager.getCLayer() + "-layer" !== layerID) {
                    listItems.push({
                        name: "Set Current",
                        action: function () {
                            console.log("Set Current clicked layer:", layerIndex)
                            designCore.layerManager.setCLayer(designCore.layerManager.getLayerByIndex(layerIndex).name);
                            closePopover();
                            loadLayers();

                        }
                    })
                }
                popover_showList(listItems);
                break
        }
    }

    function frozen(layerName, checked) {
        console.log("frozen", layerName, checked)

        for (var layer = 0; layer < layers.length; layer++) {
            if (layers[layer].name === layerName) {
                layers[layer].frozen = checked;
            }
        }
    }

    function loadLayers() {

        var list = document.getElementById("LayerManagerList")
        list.innerHTML = '';

        for (var layerIndex = 0; layerIndex < designCore.layerManager.layerCount(); layerIndex++) {

            var layer = designCore.layerManager.getLayerByIndex(layerIndex);
            var li = document.createElement("li");

            var ListItemDiv = document.createElement("div");
            ListItemDiv.className = "Design-sidebar-listitem";
            ListItemDiv.id = layerIndex;

            var layerColour = document.createElement("div");
            layerColour.className = "Design-shape";
            layerColour.id = layer.name
            layerColour.style.backgroundColor = layer.colour;

            layerColour.onmousedown = function (e) {
                handleMouse(e, "colour", this.id, this.parentElement.getAttribute('id'))
            };

            //var layerNameDiv = document.createElement("div");

            var layerNameDiv = document.createElement("Input");
            layerNameDiv.className = "layerManagerLayerName"
            layerNameDiv.type = "text"
            layerNameDiv.value = layer.name;
            layerNameDiv.id = layer.name + "-layer"
            layerNameDiv.onmousedown = function (e) {
                handleMouse(e, "name", this.id, this.parentElement.getAttribute('id'))
            };
            layerNameDiv.onkeydown = function (e) {
                var charCode = (e.charCode) ? e.charCode : e.keyCode;
                //if enter or escape is pressed, save the layername
                if (charCode === 13 || charCode === 27) {
                    this.style.outline = "none"
                    this.blur()
                }
            };

            layerNameDiv.onblur = function () {
                if (this.value) {
                    this.style.outline = "none"
                    var layerIndex = this.parentElement.getAttribute('id');
                    console.log("this value:", this.value)
                    designCore.layerManager.renameLayer(layerIndex, this.value)
                }

                loadLayers();
            }

            var layerToggleDiv = document.createElement("div");
            layerToggleDiv.className = "LayerManagerLayerToggle"

            var toggleLabel = document.createElement("label");
            toggleLabel.className = "toggle"

            var toggle = document.createElement("Input");
            toggle.type = "checkbox"
            toggle.id = layer.name + "-toggle"
            toggle.checked = layer.on
            toggle.onclick = function () {
                //console.log("Toggle Layer " + this.id + ": " + this.checked)
                var index = this.parentElement.parentElement.parentElement.getAttribute('id')
                designCore.layerManager.getLayerByIndex(index).on = this.checked;
                designCore.canvas.requestPaint();

            }

            var tick = document.createElement("div");
            tick.className = "tick";

            var layerDetailsDiv = document.createElement("div");
            layerDetailsDiv.className = "layerManagerListItemDetails"
            layerDetailsDiv.id = layer.name + "-layerDetails"

            var sliderSpan = document.createElement("span");
            sliderSpan.className = "slider";

            li.appendChild(ListItemDiv)
            ListItemDiv.appendChild(layerColour);

            if (layer.name === designCore.layerManager.getCLayer()) {

                layerNameDiv.style.fontWeight = "bold";

                layerColourRGB = Colours.hexToRGB(layer.colour)

                if ((layerColourRGB.r * 0.299 + layerColourRGB.g * 0.587 + layerColourRGB.b * 0.114) > 186) {
                    tick.style.borderColor = "#000000"
                } else {
                    tick.style.borderColor = "#ffffff"
                }

                layerColour.appendChild(tick);
            }

            ListItemDiv.appendChild(layerNameDiv);
            ListItemDiv.appendChild(layerToggleDiv);
            layerToggleDiv.appendChild(toggleLabel)
            toggleLabel.appendChild(toggle)
            toggleLabel.appendChild(sliderSpan)


            li.appendChild(layerDetailsDiv)

            list.appendChild(li);

        }
    }

</script>


<!---------------------------------------------------
------------------- layermanager --------------------
---------------------------------------------------->

<!---------------------------------------------------
-------------------    notify    --------------------
---------------------------------------------------->
<div id="NotifyPopup" class="Notification">
    <div id="Notification-body" class="Notification-body">
    </div>
</div>


<script>
    var notificationContent = "";

    function notify(content) {
        console.log("Notification: ", content)
        notificationContent = content;
        var notification = document.getElementById("Notification-body")
        notification.innerHTML = "<p>" + content + "</p>";
        shownotification();
    }

    function notification_appendContent(content) {
        notification_clearContent();
        var notification = document.getElementById("Notification-body");
        notification.appendChild(content);
        shownotification();
    }

    function notification_clearContent() {
        var notification = document.getElementById("Notification-body")
        notification.innerHTML = '';
    }

    function shownotification() {
        document.getElementById('NotifyPopup').style.display = "block";
        setTimeout(closenotification, 5000)
    }

    function closenotification() {
        document.getElementById('NotifyPopup').style.display = "none";
        notificationContent = ""
    }

</script>

<!---------------------------------------------------
-------------------    notify    --------------------
---------------------------------------------------->

<!---------------------------------------------------
-------------------    popover   --------------------
---------------------------------------------------->
<div id="PopoverWindow" class="Popover">
    <div id="Popover-body" class="Popover-body">
    </div>
</div>


<script>
    function popover_setContent(content) {
        var popover = document.getElementById("Popover-body")
        popover.innerHTML = content;
        showPopover();
    }

    function popover_appendContent(content) {
        popover_clearContent();
        var popover = document.getElementById("Popover-body");
        popover.appendChild(content);
        showPopover();
    }

    function popover_showList(listItems) {
        var popover_list = document.createElement("ui");
        popover_list.className = "Popover-list";
        popover_list.id = "Popover-list";

        for (var i = 0; i < listItems.length; i++) {
            var listItem = document.createElement("li");
            listItem.appendChild(document.createTextNode(listItems[i].name))
            listItem.onmousedown = listItems[i].action;


            popover_list.appendChild(listItem);
        }

        popover_appendContent(popover_list)
    }

    function popover_clearContent() {
        var popover = document.getElementById("Popover-body")
        popover.innerHTML = '';
    }

    function showPopover(ev) {
        document.getElementById('PopoverWindow').style.display = "block";
        positionPopover(ev);
    }

    function closePopover() {
        document.getElementById('PopoverWindow').style.display = "none";
    }

    function positionPopover(ev) {
        var clickCoords = getPosition(ev);
        var clickCoordsX = clickCoords.x;
        var clickCoordsY = clickCoords.y;
        var popover = document.getElementById('Popover-body');

        popoverWidth = popover.offsetWidth + 4;
        popoverHeight = popover.offsetHeight + 4;

        windowWidth = window.innerWidth;
        windowHeight = window.innerHeight;

        if ((windowWidth - clickCoordsX) < popoverWidth) {
            popover.style.left = windowWidth - popoverWidth + "px";
        } else {
            popover.style.left = clickCoordsX - (popoverWidth / 2) + "px";
        }

        if ((windowHeight - clickCoordsY) < popoverHeight) {
            popover.style.top = windowHeight - popoverHeight - 10 + "px";
        } else {
            popover.style.top = clickCoordsY + 10 + "px";
        }
    }

    function getPosition(ev) {
        var posx = 0;
        var posy = 0;

        if (!e) var e = window.event;

        if (e.pageX || e.pageY) {
            posx = e.pageX;
            posy = e.pageY;
        } else if (e.clientX || e.clientY) {
            posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
            posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
        }

        return {
            x: posx,
            y: posy
        }
    }

    // When the user clicks anywhere outside of the dialogs, close them
    window.onclick = function (event) {
        if (event.target == document.getElementById('PopoverWindow')) {
            console.log("CLOSE CLOSE CLOSE CLOSE")
            document.getElementById('PopoverWindow').style.display = "none";
        }
    }

</script>

<!---------------------------------------------------
-------------------    popover   --------------------
---------------------------------------------------->


<!---------------------------------------------------
------------------- properties  --------------------
---------------------------------------------------->
<div id="PropertiesManager" class="Design-sidebar">
    <div class="Design-header">
        <div class="Design-header-icon" , onclick="closePropertiesManager()"><img src="icons/close.svg"></div>
        <div class="Design-header-title">
            <h3>Properties</h3>
        </div>
    </div>
    <div id="PropertiesManagerContent" class="Design-sidebar-content">
        <div id="PropertiesManagerPlaceHolder" class="Design-placeholder-text">
            <p>Nothing Selected</p>
        </div>
        <ul id="PropertiesManagerList" class="Design-sidebar-list">
            <!-- Dynamically add layer list -->
        </ul>
    </div>
</div>

<script>
    function showHidePropertiesManager() {

        var PM = document.getElementById("PropertiesManager");

        if (PM.style.width > "0px") {
            closePropertiesManager();
        } else {
            closeLayerManager();
            PM.style.width = "300px";
        }
    }

    /* Set the width of the side navigation to 0 */
    function closePropertiesManager() {
        document.getElementById("PropertiesManager").style.width = "0";
    }

    function getProperties() {

        console.log(document.getElementById("PropertiesManager").style.width)
        if (document.getElementById("PropertiesManager").style.width > "0px") {
            console.log("[PropertiesManager] - getProperties()")
            if (designCore.scene.selectionManager.selectionSet.selectionSet.length) {
                document.getElementById("PropertiesManagerPlaceHolder").style.display = "none";
                loadPropertyList(designCore.propertyManager.getItemTypes())
            } else {
                clearPropertiesList()
                document.getElementById("PropertiesManagerPlaceHolder").style.display = "block";
            }
        }
    }


    function clearPropertiesList() {
        var list = document.getElementById("PropertiesManagerList")
        list.innerHTML = '';
    }

    function loadPropertyList(itemList) {
        var list = document.getElementById("PropertiesManagerList")
        clearPropertiesList()

        for (var item = 0; item < itemList.length; item++) {

            var li = document.createElement("li");

            var ListItemDiv = document.createElement("div");
            ListItemDiv.className = "Design-sidebar-listitem";
            ListItemDiv.id = itemList[item];
            ListItemDiv.onmousedown = function (e) {
                showHideItemProperties(this.id)
            };

            var type = document.createTextNode(itemList[item])
            var itemPropertiesDiv = document.createElement("div");
            itemPropertiesDiv.className = "layerManagerListItemDetails"
            itemPropertiesDiv.id = itemList[item] + "-itemProperties"


            ListItemDiv.appendChild(type);
            li.appendChild(ListItemDiv)
            li.appendChild(itemPropertiesDiv)
            list.appendChild(li);

        }
    }

    function loadItemProperties(elemID) {
        var itemType = elemID;
        var propertiesList = designCore.propertyManager.getItemProperties(itemType)
        var detailsDiv = document.getElementById(elemID + "-itemProperties")
        //console.log(propertiesList)
        var props = "";
        for (var property = 0; property < propertiesList.length; property++) {
            console.log("[propertiesManager.loadItemProperties()]: type:", itemType, " property: ", propertiesList[property])

            var propValue = designCore.propertyManager.getItemPropertyValue(itemType, propertiesList[property])

            props += '\
        <div class="Design-sidebar-listitem"> \
		<div class="Design-sidebar-listitem-child"><p>' + propertiesList[property] + '</p></div>';

            switch (propertiesList[property]) {

                case "width":
                    props += '<div class="Design-sidebar-listitem-child"> <input type="text" value=' + propValue + '></div>'
                    break;
                case "height":
                    props += '<div class="Design-sidebar-listitem-child"> <input type="text" value=' + propValue + '></div>'
                    break;
                case "rotation":
                    props += '<div class="Design-sidebar-listitem-child"> <input type="text" value=' + propValue + '></div>'
                    break;
                case "radius":
                    props += '<div class="Design-sidebar-listitem-child"> <input type="text" value=' + propValue + '></div>'
                    break;
                case "lineWidth":
                    props += '<div class="Design-sidebar-listitem-child"> <input type="text" value=' + propValue + '></div>'
                    break;
                case "colour":
                    props += '<div class="Design-sidebar-listitem-child"><select>';
                    props += '<option>' + propValue + '</option>';
                    for (var ACI = 0; ACI < 256; ACI++) {
                        props += '<option>' + ACI + '</option>';
                    }
                    props += '</select></div>';
                    break;
                case "layer":

                    props += '<div id="design-dropdown" onclick="showDD()" class="wrapper-dropdown-2">' + designCore.layerManager.getCLayer() + '<ul class="dropdown"> '
                    // <li><a href="#"><i class="icon-twitter icon-large"></i>Twitter</a></li> \
                    //    <li><a href="#"><i class="icon-github icon-large"></i>Github</a></li> \
                    //    <li><a href="#"><i class="icon-facebook icon-large"></i>Facebook</a></li> \

                    for (var layerIndex = 0; layerIndex < designCore.layerManager.layerCount(); layerIndex++) {
                        if (designCore.layerManager.getLayerByIndex(layerIndex).name !== designCore.layerManager.getCLayer()) {
                            props += '<li style="border-left-color: #38B44A">' + designCore.layerManager.getLayerByIndex(layerIndex).name + '</li>';
                        }
                    }

                    props += '</ul> \
                                    </div>'
                    /* props += '<div class="Design-sidebar-listitem-child"><select>';
                     for (var layerIndex = 0; layerIndex < LM.layerCount(); layerIndex++) {
                       props +=  '<option>' + LM.getLayerByIndex(layerIndex).name + '</option>'; 
                     }
                     props += '</select></div>'; 
                     */
                    break;
                default:
                    props += '<div class="Design-sidebar-listitem-child"><p>' + propValue + '</p></div>'
                    break;
            }



            props += '</div>';
        }
        detailsDiv.innerHTML = props;
        return propertiesList.length;
    }

    function showHideItemProperties(elemID) {
        var elem = document.getElementById(elemID + "-itemProperties")
        var elemIDstate = elem.style.display;
        console.log("[propertiesManager.js - showHideItemProperties()]:", elemID, elemIDstate)

        //hide any expanded sections

        var divs = document.querySelectorAll("[id]");
        for (var i = 0, len = divs.length; i < len; i++) {
            var div = divs[i];
            if (div.id.indexOf("itemProperties") > -1) {
                div.style.height = "0px";
                div.style.display = "none";
            }
        }

        if (elemIDstate !== "block") {
            elem.style.display = "block";
            var items = loadItemProperties(elemID);
            var height = items * 50 //TO DO: Get height from CSS
            elem.style.height = height.toString() + "px";
        }
    }
</script>

<!---------------------------------------------------
------------------- properties  --------------------
---------------------------------------------------->

<!---------------------------------------------------
------------------- settings  --------------------
---------------------------------------------------->

<div id="SettingsWindow" class="Settings">
    <div class="Settings-content">
        <div class="Design-header">
            <div class="Design-header-icon" , onclick="closeSettings()"><img src="icons/close.svg"></div>
            <div class="Design-header-title">
                <h3>Settings</h3>
            </div>
        </div>
        <div class="Settings-body">

            <div class="tab">
                <button class="tablinks" onclick="changeTab(event, 'Colour')" id="defaultOpen">Colour</button>
                <button class="tablinks" onclick="changeTab(event, 'Snaps')">Snaps</button>
                <button class="tablinks" onclick="changeTab(event, 'Text'); loadStyleList();">Text</button>
                <button class="tablinks" onclick="changeTab(event, 'Accounts')">Accounts</button>
                <button class="tablinks" onclick="changeTab(event, 'Help')">Help</button>
                <button class="tablinks" onclick="changeTab(event, 'About')">About</button>
            </div>

            <div id="tabcontent" class="tabcontent">
                <!-- Autoload tab content here -->
            </div>

            <!---------------------------------------------------
-------------------   colours    --------------------
---------------------------------------------------->
            <!-- Tab content -->
            <div id="Colour" class="tabcontent">

                <div class="row">
                    <div class="column">
                        <ul>
                            <div class="Design-sidebar-listitem">
                                <div id="canvasBackgroundColour" class="Design-shape" onclick="changeColour(this.id)">
                                </div>
                                <p>Canvas Background Colour</p>
                                <div></div>
                            </div>
                            <div class="Design-sidebar-listitem">
                                <div id="selectedItemsColour" class="Design-shape" onclick="changeColour(this.id)">
                                </div>
                                <p>Selected Items Colour</p>
                                <div></div>
                            </div>
                            <div class="Design-sidebar-listitem">
                                <div id="snapColour" class="Design-shape" onclick="changeColour(this.id)"></div>
                                <p>Snap Colour</p>
                                <div></div>
                            </div>
                            <div class="Design-sidebar-listitem">
                                <div id="helperGeometryColour" class="Design-shape" onclick="changeColour(this.id)">
                                </div>
                                <p>Helper Geometry Colour</p>
                                <div></div>
                            </div>
                            <div class="Design-sidebar-listitem">
                                <div id="polarSnapColour" class="Design-shape" onclick="changeColour(this.id)"></div>
                                <p>Polar Snap Colour</p>
                                <div></div>
                            </div>
                            <div class="Design-sidebar-listitem">
                                <div id="gridColour" class="Design-shape" onclick="changeColour(this.id)"></div>
                                <p>Grid Colour</p>
                                <div></div>
                            </div>
                        </ul>
                    </div>
                </div>
            </div>

            <!---------------------------------------------------
-------------------    snaps     --------------------
---------------------------------------------------->
            <div id="Snaps" class="tabcontent">
                <div class="row">
                    <div class="column">
                        <ul>

                            <div id="Endsnap" class="Design-sidebar-listitem">
                                <img src="icons/snap-end.svg" style="width:32px;height:32px;">
                                <p>End</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('endSnap')"
                                        checked=function(){designCore.settings["endSnap"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div id="Midsnap" class="Design-sidebar-listitem">
                                <img src="icons/snap-mid.svg" style="width:32px;height:32px;">
                                <p>Mid</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('midSnap')"
                                        checked=function(){designCore.settings["midSnap"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div id="Centresnap" class="Design-sidebar-listitem">
                                <img src="icons/snap-centre.svg" style="width:32px;height:32px;">
                                <p>Centre</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('centreSnap')"
                                        checked=function(){designCore.settings["centreSnap"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div id="Nearestsnap" class="Design-sidebar-listitem">
                                <img src="icons/snap-nearest.svg" style="width:32px;height:32px;">
                                <p>Nearest</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('nearestSnap')"
                                        checked=function(){designCore.settings["nearestSnap"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </ul>
                    </div>

                    <div class="column">
                        <ul>
                            <div id="Polar" class="Design-sidebar-listitem">
                                <img src="icons/polar.svg" style="width:32px;height:32px;">
                                <p>Polar</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('polar')"
                                        checked=function(){designCore.settings["polar"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div id="PolarAngle" class="Design-sidebar-listitem">
                                <p>Polar Angle</p>
                                <select id="polarAngle" onchange="changePolarAngle(this.value)" ;>
                                    <option value="22.5">22.5</option>
                                    <option value="45">45</option>
                                    <option value="90">90</option>
                                    <option value="180">180</option>
                                </select>
                            </div>

                            <div id="Ortho" class="Design-sidebar-listitem">
                                <img src="icons/ortho.svg" style="width:32px;height:32px;">
                                <p>Ortho</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('ortho')"
                                        checked=function(){designCore.settings["ortho"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div id="Grid" class="Design-sidebar-listitem">
                                <img src="icons/grid.svg" style="width:32px;height:32px;">
                                <p>Show Grid</p>
                                <label class="toggle">
                                    <input type="checkbox" onclick="toggleSnap('drawGrid')"
                                        checked=function(){designCore.settings["drawGrid"]};>
                                    <span class="slider"></span>
                                </label>
                            </div>

                        </ul>
                    </div>
                </div>
            </div>

            <!---------------------------------------------------
-------------------   styles    --------------------
---------------------------------------------------->
            <div id="Text" class="tabcontent">

                <div class="row">
                    <div class="column">
                        <p> Styles: </p>
                        <ul id="StylesManagerList" class="Design-sidebar-list">
                            <!-- Dynamically add layer list -->
                        </ul>
                    </div>

                    <div class="column">
                        <div id="font" class="Design-sidebar-listitem">
                            <p>Font</p>
                            <select id="fontSelect" onchange="updateStyle()" ;>
                            </select>
                        </div>

                        <div id="fontStyle" class="Design-sidebar-listitem">
                            <p>Font Style</p>
                            <select id="fontStyleSelect" onchange="updateStyle()" ;>
                            </select>
                        </div>

                        <div class="Design-sidebar-listitem">
                            <p>Text Height</p>
                            <input id="textHeightInput" type="number" onkeypress="updateStyle()" ;>
                        </div>

                        <div id="styleWidthFactor" class="Design-sidebar-listitem">
                            <p>Width Factor</p>
                            <input id="widthFactorInput" type="number" onchange="updateStyle()" ;>
                            </label>
                        </div>

                        <div id="styleObliqueAngle" class="Design-sidebar-listitem">
                            <p>Oblique Angle</p>
                            <input id="obliqueAngleInput" type="number" onchange="updateStyle()" ;>
                            </label>
                        </div>

                        <div id="styleUpsideDown" class="Design-sidebar-listitem">
                            <p>Upside Down</p>
                            <label class="toggle">
                                <input type="checkbox" id="upsideDownToggle" onclick="updateStyle()" ;>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div id="styleBackwards" class="Design-sidebar-listitem">
                            <p>Backwards</p>
                            <label class="toggle">
                                <input type="checkbox" id="backwardsToggle" onclick="updateStyle()" ;>
                                <span class="slider"></span>
                            </label>

                        </div>
                    </div>
                </div>
            </div>

            <!---------------------------------------------------
-------------------   Accounts   --------------------
---------------------------------------------------->

            <div id="Accounts" class="tabcontent">
                <h3>Accounts</h3>
                <p>Placeholder for Online Accounts settings</p>
            </div>

            <div id="Help" class="tabcontent">
                <h3>Help</h3>
                <div class="row">
                    <div class="column" style="text-align: center;">
                        <a href="https://design-app.readthedocs.io" target="_blank"><img src="icons/online-help.svg"
                                height="100"></a>
                        <h4>Online Help</h4>
                    </div>
                    <div class="column" style="text-align: center;">
                        <a href="https://design-app.readthedocs.io/_/downloads/en/latest/pdf/" target="_blank"><img
                                src="icons/pdf-file.svg" height="100"></a>
                        <h4>Offline Help</h4>
                    </div>
                    <div class="column" style="text-align: center;">
                        <a href="https://t.me/joinchat/BQHZRA1R0Ke297gkQEJEEQ" target="_blank"><img
                                src="icons/telegram-logo.svg" height="100"></a>
                        <h4>Telegram Group</h4>
                    </div>
                </div>
            </div>

            <!---------------------------------------------------
-------------------   About    --------------------
---------------------------------------------------->

            <div id="About" class="tabcontent">
                <h3>About</h3>
                <p>Design is a 2D CAD application for the web. Design is a 2D computer aided design application (CAD),
                    created to meet the needs of makers and designers, hobbyists and professionals that require a first
                    class CAD application.</p>

                <h4>GitHub: <a href="https://github.com/dubstar-04/Design">https://github.com/dubstar-04/Design</a></h4>
                <h4> Version:
                    <script type="text/javascript">
                        document.write(designVersion)
                    </script>
                </h4>

            </div>
        </div>
    </div>
</div>


<script>
    function loadStyleList() {

        // get a list of available fonts
        getFonts();
        //set font style options
        var fontStyleSelect = document.getElementById("fontStyleSelect")

        for (i = fontStyleSelect.options.length; i >= 0; i--) {
            fontStyleSelect.remove(i);
        }

        var fontStyles = {
            1: "Regular",
            2: "Bold",
            3: "Italic"
        };

        for (index in fontStyles) {
            fontStyleSelect.options[fontStyleSelect.options.length] = new Option(fontStyles[index], index);
        }



        var list = document.getElementById("StylesManagerList")
        clearStylesList()

        styles = SM.getStyles()

        for (var item = 0; item < styles.length; item++) {

            var li = document.createElement("li");


            var ListItemDiv = document.createElement("div");
            ListItemDiv.className = "Design-sidebar-listitem";
            ListItemDiv.id = styles[item].name;
            ListItemDiv.onmousedown = function (e) {
                loadStyleData(this.id)
            };

            var type = document.createTextNode(styles[item].name)
            ListItemDiv.appendChild(type);
            li.appendChild(ListItemDiv)
            list.appendChild(li);
        }


        //load the first style available
        loadStyleData(SM.getStyleByIndex(0).name)
    }

    function loadStyleData(styleName) {

        console.log("load style: ", styleName)

        var style = SM.getStyleByName(styleName)

        var fontStyle = document.getElementById("fontSelect")
        var fontStyleSelect = document.getElementById("fontStyleSelect")
        var textHeightInput = document.getElementById("textHeightInput")
        var styleWidthFactor = document.getElementById("widthFactorInput")
        var styleObliqueAngle = document.getElementById("obliqueAngleInput")
        var styleUpsideDown = document.getElementById("upsideDownToggle")
        var styleBackwards = document.getElementById("backwardsToggle")

        console.log("StyleData: ", style)

        fontStyle.value = style.font
        fontStyleSelect.value = style.font
        textHeightInput.value = style.textHeight
        styleWidthFactor.value = style.widthFactor
        styleObliqueAngle.value = style.obliqueAngle
        styleUpsideDown.checked = style.upsideDown
        styleBackwards.checked = style.backwards
    }

    function clearStylesList() {
        var list = document.getElementById("StylesManagerList")
        list.innerHTML = '';
    }

    function updateStyle() {

        console.log("Update Style")
    }

    function changeColour(caller) {
        console.log("Caller: ", caller)
        showColourPicker(null, settingColourChange, caller)
    }

    function settingColourChange(colour, caller) {
        console.log("change ", caller, " to: ", colour);
        designCore.settings[caller] = colour
        saveAllSettings()
        setDefaultSettings()
        designCore.canvas.requestPaint()
    }


    var cookieConsent = false;

    function getCookieConsent() {
        var cookiesAllowed = getSettings("Design")

        if (cookiesAllowed != "") {
            cookieConsent = true;
            loadAllSettings()
        } else {
            showWelcomeWizzard();
        }
    }

    function cookiesAccepted() {
        console.log("cookies Accepted")
        cookieConsent = true;
        saveSetting("Design", designVersion, 365);
        saveAllSettings()
    }

    function toggleSnap(snap) {
        designCore.settings[snap] = !designCore.settings[snap]
        saveAllSettings()
    }

    function changePolarAngle(angle) {

        console.log("Angle:", angle)
        designCore.settings["polarAngle"] = angle;
        saveAllSettings();
    }

    function changeFont(font) {
        console.log("Selected Font:", font)
        designCore.settings["font"] = font;
        saveAllSettings();
    }

    function saveAllSettings() {
        if (cookieConsent) {
            for (var setting in Object.keys(designCore.settings)) {
                //console.log("Setting:", setting, " value: ", designCore.settings[setting])
                saveSetting(setting, designCore.settings[setting])
            }
        } else {
            console.log("settings won't be saved")
        }
    }

    function loadAllSettings() {
        for (var setting in Object.keys(designCore.settings)) {
            //console.log("getSetting:", setting, " value: ", getSettings(setting))
            designCore.settings.setSetting(setting, getSettings(setting))
        }
    }

    function saveSetting(name, value) {
        var d = new Date();
        d.setTime(d.getTime() + (365 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
    }

    function getSettings(name) {
        var name = name + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }


    function changeTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        setDefaultSettings();
    }

    function setDefaultSettings() {
        //set defaults
        document.getElementById("polarAngle").value = designCore.settings["polarAngle"]
        document.getElementById("canvasBackgroundColour").style.backgroundColor = designCore.settings["canvasBackgroundColour"]
        document.getElementById("selectedItemsColour").style.backgroundColor = designCore.settings["selectedItemsColour"]
        document.getElementById("snapColour").style.backgroundColor = designCore.settings["snapColour"]
        document.getElementById("helperGeometryColour").style.backgroundColor = designCore.settings["helperGeometryColour"]
        document.getElementById("polarSnapColour").style.backgroundColor = designCore.settings["polarSnapColour"]
        document.getElementById("gridColour").style.backgroundColor = designCore.settings["gridColour"]
    }


    function getFonts() {

        var fontDetector = function () {
            // a font will be compared against all the three default fonts.
            // and if it doesn't match all 3 then that font is not available.
            var baseFonts = ['monospace', 'sans-serif', 'serif'];

            //we use m or w because these two characters take up the maximum width.
            // And we use a LLi so that the same matching fonts can get separated
            var testString = "mmmmmmmmmmlli";

            //we test using 72px font size, we may use any size. I guess larger the better.
            var testSize = '72px';

            var h = document.getElementsByTagName("body")[0];

            // create a SPAN in the document to get the width of the text we use to test
            var s = document.createElement("span");
            s.style.fontSize = testSize;
            s.innerHTML = testString;
            var defaultWidth = {};
            var defaultHeight = {};
            for (var index in baseFonts) {
                //get the default width for the three base fonts
                s.style.fontFamily = baseFonts[index];
                h.appendChild(s);
                defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font
                defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font
                h.removeChild(s);
            }

            function detect(font) {
                var detected = false;
                for (var index in baseFonts) {
                    s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.
                    h.appendChild(s);
                    var matched = (s.offsetWidth != defaultWidth[baseFonts[index]] || s.offsetHeight != defaultHeight[baseFonts[index]]);
                    h.removeChild(s);
                    detected = detected || matched;
                }
                return detected;
            }

            this.detect = detect;
        };

        var fonts = ["Arial", "Helvetica", "Times New Roman", "Times", "Courier New", "Courier", "Verdana", "Georgia", "Palatino", "Garamond", "Bookman", "Comic Sans MS", "Trebuchet MS", "Impact"];

        //var availableFonts = [];				
        d = new fontDetector();
        var fontSelector = document.getElementById('fontSelect')
        var fontSelectorLength = fontSelector.options.length

        for (i = fontSelectorLength; i >= 0; i--) {
            //console.log("Remove Font: ", fonts[i], " From Index: ", i)
            fontSelector.remove(i);
        }

        for (font = 0; font < fonts.length - 1; font++) {
            if (d.detect(fonts[font])) {
                var fontOption = document.createElement("option");
                fontOption.text = fonts[font]
                fontSelector.options.add(fontOption);
            };
        }
    }

    function showSettings() {
        document.getElementById('SettingsWindow').style.display = "block";
        document.getElementById("defaultOpen").click();
    }

    function closeSettings() {
        console.log("Close Settings")
        document.getElementById('SettingsWindow').style.display = "none";
    }

    // When the user clicks anywhere outside of the dialogs, close them
    window.onclick = function (event) {
        if (event.target == document.getElementById('SettingsWindow')) {
            closeSettings();
        }
    }
</script>

<!---------------------------------------------------
------------------- settings  --------------------
---------------------------------------------------->

<!---------------------------------------------------
------------------- welcomewizzard --------------------
---------------------------------------------------->

<div id="WelcomeWizzard" class="WelcomeWizzard">
    <div class="WelcomeWizzard-content">
        <div class="Design-header">
            <div class="Design-header-title">
                <h3>Welcome</h3>
            </div>
            <div class="skipButton" , onclick="closeWelcomeWizzard()">
                <p>skip</p>
            </div>
        </div>
        <div class="WelcomeWizzard-body">
            <div class="slideshow-container">
                <div class="slide-container">
                    <div class="slides fade">
                        <div class="image"><img src="icons/design-small.svg"></div>
                        <div class="title">Welcome To Design</div>
                        <div class="text">Design is a 2D CAD application for makers, designer, hobbyists and
                            Professionals.</div>
                        <br>
                        <br>
                        <div class="text">
                            <button id="cookieButton" , class="button" , style="width:25%" ;>Accept</button>
                            <div id="cookieShape" , class="Design-shape" ,
                                style="background-Color:#38B44A; visibility:hidden" ;>
                                <div class="tick"></div>
                            </div>

                        </div>
                        <div class="text">We use cookies to store app settings between sessions.</div>
                    </div>

                    <div class="slides fade">
                        <div class="image"><img src="icons/convergence.svg"></div>
                        <div class="title">Design Everywhere!</div>
                        <div class="text">Design was created with cross browser compatability. Design works where you
                            are. </div>
                    </div>

                    <div class="slides fade">
                        <div class="image"><img src="icons/dxf-file.svg"></div>
                        <div class="title">Plays Well With Others...</div>
                        <div class="text">Design uses industry standard DXF files for compatability and simplicity.
                        </div>
                    </div>

                    <div class="slides fade">
                        <div class="image"><img src="icons/design-small.svg"></div>
                        <div class="title">Learn, Create, Have Fun!</div>
                        <div class="text">We love CAD and we want you to also. Check the help tab in settings for tips
                            to get going with your designs. </div>
                        <br>
                        <div class="text">
                            <button class="button" , style="width:25%" , onclick="closeWelcomeWizzard()" ;>Get
                                Started!</button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="navigation-bar">
                <div>
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                </div>
                <div class="dot-container">
                    <span class="dot" onclick="currentSlide(1)"></span>
                    <span class="dot" onclick="currentSlide(2)"></span>
                    <span class="dot" onclick="currentSlide(3)"></span>
                    <span class="dot" onclick="currentSlide(4)"></span>
                </div>
                <div>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                </div>
            </div>

        </div>
    </div>
</div>


<script>
    var cookieButton = document.getElementById("cookieButton");

    cookieButton.onclick = function () {
        var cookieShape = document.getElementById("cookieShape");

        cookieButton.classList.add("disabledbutton");
        cookieShape.style.visibility = 'visible'
        cookiesAccepted()
    }

    function showWelcomeWizzard() {
        document.getElementById('WelcomeWizzard').style.display = "block";
    }

    function closeWelcomeWizzard() {
        document.getElementById('WelcomeWizzard').style.display = "none";
    }

    var slideIndex = 1;
    showSlides(slideIndex);

    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    function showSlides(n) {
        var i;
        var slides = document.getElementsByClassName("slides");
        var dots = document.getElementsByClassName("dot");
        if (n > slides.length) {
            slideIndex = slides.length
        }
        if (n < 1) {
            slideIndex = 1
        }
        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        for (i = 0; i < dots.length; i++) {
            dots[i].className = dots[i].className.replace(" active", "");
        }
        slides[slideIndex - 1].style.display = "block";
        dots[slideIndex - 1].className += " active";
    }
</script>

<!---------------------------------------------------
------------------- welcome Wizard ------------------
---------------------------------------------------->

</html>